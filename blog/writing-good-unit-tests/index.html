<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.66">
<title data-react-helmet="true">编写良好的单元测试 | Docusaurus Search</title><meta data-react-helmet="true" property="og:title" content="编写良好的单元测试 | Docusaurus Search"><meta data-react-helmet="true" name="description" content="本文转载自 https://wangshenwei.com/writing-good-unit-tests/ 。"><meta data-react-helmet="true" property="og:description" content="本文转载自 https://wangshenwei.com/writing-good-unit-tests/ 。"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docusaurus_language" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><link data-react-helmet="true" rel="shortcut icon" href="/docusaurus-search-example/img/favicon.ico"><link rel="stylesheet" href="/docusaurus-search-example/styles.af351325.css">
<link rel="preload" href="/docusaurus-search-example/styles.f2870210.js" as="script">
<link rel="preload" href="/docusaurus-search-example/runtime~main.8a9c66a5.js" as="script">
<link rel="preload" href="/docusaurus-search-example/main.0ce94817.js" as="script">
<link rel="preload" href="/docusaurus-search-example/1.17a4fed8.js" as="script">
<link rel="preload" href="/docusaurus-search-example/2.aafee8be.js" as="script">
<link rel="preload" href="/docusaurus-search-example/3.cd1e8e94.js" as="script">
<link rel="preload" href="/docusaurus-search-example/01a85c17.28c14202.js" as="script">
<link rel="preload" href="/docusaurus-search-example/1be78505.234dbae8.js" as="script">
<link rel="preload" href="/docusaurus-search-example/6875c492.fb6a94b6.js" as="script">
<link rel="preload" href="/docusaurus-search-example/a6aa9e1f.d5672d9d.js" as="script">
<link rel="preload" href="/docusaurus-search-example/c4f5d8e4.a1ac55f7.js" as="script">
<link rel="preload" href="/docusaurus-search-example/ccc49370.2a541413.js" as="script">
<link rel="preload" href="/docusaurus-search-example/36.634c5bac.js" as="script">
<link rel="preload" href="/docusaurus-search-example/46879248.1993293b.js" as="script">
<link rel="preload" href="/docusaurus-search-example/3a35335b.1217ed36.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/docusaurus-search-example/"><img class="navbar__logo" src="/docusaurus-search-example/img/logo.svg" alt="My Site Logo"><strong class="navbar__title">Docusaurus Search</strong></a><a class="navbar__item navbar__link" href="/docusaurus-search-example/docs/">Docs</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docusaurus-search-example/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/easyops-cn/docusaurus-search-local" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2aTZ"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_BsTx">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_BsTx">🌞</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div><div class="navbar__search"><input placeholder="Search" aria-label="Search" class="navbar__search-input"><div class="lds-ring"><div></div><div></div><div></div><div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/docusaurus-search-example/"><img class="navbar__logo" src="/docusaurus-search-example/img/logo.svg" alt="My Site Logo"><strong class="navbar__title">Docusaurus Search</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docusaurus-search-example/docs/">Docs</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/docusaurus-search-example/blog">Blog</a></li><li class="menu__list-item"><a href="https://github.com/easyops-cn/docusaurus-search-local" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="container margin-vert--lg"><div class="row"><div class="col col--2"><div class="sidebar_3I7I"><h3 class="sidebarItemTitle_2Dv3">Recent posts</h3><ul class="sidebarItemList_1RlG"><li class="sidebarItem_Hxgp"><a aria-current="page" class="sidebarItemLink_3ppv sidebarItemLinkActive_3XUi" href="/docusaurus-search-example/blog/writing-good-unit-tests">编写良好的单元测试</a></li><li class="sidebarItem_Hxgp"><a class="sidebarItemLink_3ppv" href="/docusaurus-search-example/blog/welcome">Welcome</a></li><li class="sidebarItem_Hxgp"><a class="sidebarItemLink_3ppv" href="/docusaurus-search-example/blog/hello-world">Hello</a></li><li class="sidebarItem_Hxgp"><a class="sidebarItemLink_3ppv" href="/docusaurus-search-example/blog/hola">Hola</a></li></ul></div></div><div class="col col--8"><article><header><h1 class="margin-bottom--sm blogPostTitle_1mse">编写良好的单元测试</h1><div class="margin-vert--md"><time datetime="2019-06-15T00:00:00.000Z" class="blogPostDate_3bQP">June 15, 2019  · 2 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/weareoutman" target="_blank" rel="noreferrer noopener"><img src="https://avatars2.githubusercontent.com/u/2338946?s=460&amp;v=4" alt="Wang Shenwei"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/weareoutman" target="_blank" rel="noreferrer noopener">Wang Shenwei</a></h4><small class="avatar__subtitle"></small></div></div></header><section class="markdown"><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>本文转载自 <a href="https://wangshenwei.com/writing-good-unit-tests/">https://wangshenwei.com/writing-good-unit-tests/</a> 。</p></div></div><blockquote><p>“万物之始，大道至简”</p></blockquote><p>本文尝试从简单的单元测试思想着手，探讨如何编写良好的单元测试。以下将主要基于 <a href="https://www.typescriptlang.org/">TypeScript</a>, <a href="https://jestjs.io/">Jest</a>, <a href="https://reactjs.org/">React</a>, <a href="https://airbnb.io/enzyme/">Enzyme</a> 给出示例。关于单元测试的<a href="https://zh.wikipedia.org/wiki/%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95">基本概念和重要性</a>不在本文讨论范围。</p><h2 id="基本方法">基本方法</h2><p>编写单元测试的基本方法其实很简单：</p><ol><li>给定输入</li><li>运行</li><li>断言输出</li></ol><p>而一个好的单元测试的要求也很简单：</p><ul><li>覆盖足够的输入场景</li><li>进行充分的输出断言</li></ul><p>一个最简单的例子：</p><pre><code class="language-ts">// `add.ts`
function add(a: number, b: number): number {
  return a + b;
}
</code></pre><pre><code class="language-ts">// `add.spec.ts`
test(&quot;add(1, 2) should return 3&quot;, () =&gt; {
  expect(add(1, 2)).toBe(3);
});
</code></pre><p>我们编写单元测试的步骤如下：</p><ol><li>给定输入：<code>1</code>, <code>2</code></li><li>运行： <code>add(...)</code></li><li>断言输出：<code>expect(...).toBe(3)</code></li></ol><p>是不是很简单？当然，真实业务场景下我们要测试的单元远比上述例子复杂得多。</p><ul><li>输入更加复杂，除了普通的函数输入参数，还可能有外部的事件，因此难以覆盖所有场景</li><li>输出更加复杂，除了普通的函数输出结果，还可能有对外部的副作用，因此难以断言运行结果</li></ul><blockquote><p>这里提到的<em>输入</em>、<em>输出</em>不再是狭义上的函数输入、输出。我们将所有可能影响测试对象行为的外部因素都称之为输入，将所有测试对象运行后对外部造成的影响都称之为输出。这样理解之后，我们就可以化繁为简，将测试过程回归到前面提到的最基本的方法上。</p></blockquote><p>所以编写良好的单元测试首先要做的就是厘清测试对象的输入、输出，掌握覆盖不同形式的输入、断言不同形式的输出的方法。我们将分开讨论它们。</p><h2 id="输入">输入</h2><p>足够简单的输入让我们可以花更少的时间、覆盖更多的场景。输入的来源大致有以下几种：</p><ul><li>普通变量参数</li><li>外部依赖发送的事件</li><li>GUI 操作事件</li></ul><p>编写测试覆盖它们的复杂度依次增大。除了第一个，其它都可以看作<em>外部事件</em>，也可以理解为<em>来自外界的副作用</em>。对于普通变量参数，我们只需构造这些参数即可完成<em>给定输入</em>的任务。而对于外部事件，我们要做的就是想办法触发这些事件。</p><p>我们依然看一个简单的例子：</p><pre><code class="language-ts">// `MyComponent.ts`
window.addEventListener(&quot;resize&quot;, () =&gt; { ... });
</code></pre><p>如何覆盖？主动发送这个事件：</p><pre><code class="language-ts">// `MyComponent.spec.ts`
test(&quot;MyComponent&quot;, () =&gt; {
  window.dispatchEvent(new Event(&quot;resize&quot;));
  // ...
});
</code></pre><p>再看一个例子：</p><pre><code class="language-ts">// `MyComponent.tsx`
const handleChange = (value: string): void =&gt; { ... };
return &lt;Editor onChange={handleChange} /&gt;
</code></pre><p>如何覆盖依赖组件的特定事件？主动触发依赖组件的事件：</p><pre><code class="language-ts">// `MyComponent.spec.tsx`
test(&quot;MyComponent&quot;, () =&gt; {
  const wrapper = shallow(&lt;MyComponent /&gt;);
  wrapper.find(Editor).invoke(&quot;onChange&quot;)(&quot;faked value&quot;);
  // ...
});
</code></pre><h2 id="输出">输出</h2><p>足够简单的输出让我们可以更容易地断言运行结果。输出的形态大致有以下几种：</p><ul><li>普通变量输出</li><li>GUI 的变化</li><li>外部依赖的调用</li></ul><p>在测试中对它们进行断言的复杂度依次增大。除了第一个，其它都可以看作<em>对外界的副作用</em>。对于普通变量输出，我们只需简单地断言它的值即可。而对于对外界的副作用，我们要做的就是想办法断言这些副作用的影响。</p><p>我们继续看一个简单的例子：</p><pre><code class="language-ts">// `handleClick.ts`
function handleClick(): void {
  history.push(&quot;/next/url&quot;);
}
</code></pre><p>如何断言？我们可以断言副作用的影响结果：</p><pre><code class="language-ts">// `handleClick.spec.ts`
test(&quot;handleClick&quot;, () =&gt; {
  handleClick();
  expect(history.location.pathname).toBe(&quot;/next/url&quot;);
});
</code></pre><p>有时副作用所影响的结果难以断言，或者该依赖被 <em>Mocked</em>，那么我们可以监视该副作用的触发点是否被正确调用了：</p><pre><code class="language-ts">// `handleClick.spec.ts`
test(&quot;handleClick&quot;, () =&gt; {
  const spyOnHistoryPush = jest.spyOn(history, &quot;push&quot;);
  expect(spyOnHistoryPush).toBeCalledWith(&quot;/next/url&quot;);
});
</code></pre><p>再看一个 React 组件的例子：</p><pre><code class="language-ts">// `MyComponent.tsx`
const handleValidation = (valid: boolean): void =&gt; {
  this.setState({ valid });
}
return &lt;Form.Item className={ this.state.valid ? &quot;valid&quot; : &quot;invalid&quot; }&gt;&lt;Input /&gt;&lt;/Form.Item&gt;;
</code></pre><p>如何断言？判断依赖组件的变化：</p><pre><code class="language-ts">// `MyComponent.spec.tsx`
test(&quot;MyComponent&quot;, () =&gt; {
  const wrapper = shallow(&lt;MyComponent /&gt;);
  // ... after something trigger `handleValidation()`
  expect(wrapper.find(Form.Item).prop(&quot;className&quot;)).toBe(&quot;invalid&quot;);
});
</code></pre><p>始终记得要断言测试对象运行后对外界的副作用影响。</p><p>另外断言的目标应该是<em>对外的影响</em>，而不是<em>内部状态</em>，因为内部状态并不是测试对象的<em>输出</em>。一个错误的例子：</p><pre><code class="language-ts">// `MyComponent.bad.spec.tsx`
expect(wrapper.instance().state.valid).toBe(&quot;invalid&quot;);
</code></pre><h2 id="重构与拆分">重构与拆分</h2><p>更简单的输入、输出让我们可以更容易地编写好的单元测试，但往往实际情况是业务需求不断增长，组件内部逻辑不断复杂化，输入输出的形式形态更加多样化，为组件编写单元测试的难度也随之陡增。</p><p><strong>适时地重构与拆分</strong>是解决这个问题的关键。在如今的前端组件化的模式下尤为重要，合理拆分后的组件可以让每个测试单元的输入输出都变得更少、更聚焦。诸如 React, <a href="https://redux.js.org/">Redux</a> 等主流框架和工具推崇的<a href="https://flaviocopes.com/react-unidirectional-data-flow/">单向数据流</a>盛行的其中一个原因就是它们巧妙地让各个单元的输入来源、输出影响单一化，从而降低编写单元测试的难度，同时提升组件集成时的信心。</p><h2 id="总结">总结</h2><p>编写良好的单元测试总结下来就是三条：</p><ul><li>识别测试对象的输入、输出</li><li>掌握不同形态下的输入覆盖、输出断言的方法</li><li>适时地重构与拆分</li></ul><p>希望以上内容对大家有所帮助。</p></section></article><div><a href="https://github.com/easyops-cn/docusaurus-search-example/edit/master/website/blog/blog/2019-06-15-writing-good-unit-tests.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 40 40" style="margin-right:0.3em;vertical-align:sub"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="margin-vert--xl"><nav class="pagination-nav" aria-label="Blog post page navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docusaurus-search-example/blog/welcome"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Welcome »</div></a></div></nav></div></div><div class="col col--2"><div class="tableOfContents_3SO_"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#基本方法" class="table-of-contents__link">基本方法</a></li><li><a href="#输入" class="table-of-contents__link">输入</a></li><li><a href="#输出" class="table-of-contents__link">输出</a></li><li><a href="#重构与拆分" class="table-of-contents__link">重构与拆分</a></li><li><a href="#总结" class="table-of-contents__link">总结</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docusaurus-search-example/docs/">Style Guide</a></li><li class="footer__item"><a class="footer__link-item" href="/docusaurus-search-example/docs/doc2/">Second Doc</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow</a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord</a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docusaurus-search-example/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/easyops-cn/docusaurus-search-local" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div></div><div class="text--center"><div>Copyright © 2020 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/docusaurus-search-example/styles.f2870210.js"></script>
<script src="/docusaurus-search-example/runtime~main.8a9c66a5.js"></script>
<script src="/docusaurus-search-example/main.0ce94817.js"></script>
<script src="/docusaurus-search-example/1.17a4fed8.js"></script>
<script src="/docusaurus-search-example/2.aafee8be.js"></script>
<script src="/docusaurus-search-example/3.cd1e8e94.js"></script>
<script src="/docusaurus-search-example/01a85c17.28c14202.js"></script>
<script src="/docusaurus-search-example/1be78505.234dbae8.js"></script>
<script src="/docusaurus-search-example/6875c492.fb6a94b6.js"></script>
<script src="/docusaurus-search-example/a6aa9e1f.d5672d9d.js"></script>
<script src="/docusaurus-search-example/c4f5d8e4.a1ac55f7.js"></script>
<script src="/docusaurus-search-example/ccc49370.2a541413.js"></script>
<script src="/docusaurus-search-example/36.634c5bac.js"></script>
<script src="/docusaurus-search-example/46879248.1993293b.js"></script>
<script src="/docusaurus-search-example/3a35335b.1217ed36.js"></script>
</body>
</html>